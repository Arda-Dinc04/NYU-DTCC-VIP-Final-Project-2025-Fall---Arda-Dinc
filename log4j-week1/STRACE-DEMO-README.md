# `strace` Demo: Proving Dynamic Log4j Loading

## Overview

This demo shows how to use `strace` (system call tracer) to prove that a Java application dynamically loads Log4j at runtime, rather than having it as a compile-time dependency.

## Prerequisites

### Required Tools

1. **`strace`** - System call tracer

   - **Linux:** `sudo apt-get install strace` (Ubuntu/Debian) or `sudo yum install strace` (RHEL/CentOS)
   - **macOS:** `brew install strace` (may require additional setup) or use `dtruss`/`dtrace`
   - **Verify:** `strace --version`

2. **Java 17+** - For running the demo applications

   - **Verify:** `java -version`

3. **Maven** - For building the projects
   - **Verify:** `mvn -version`

### Project Setup

Ensure both demo projects are built and the dynamic demo has runtime JARs:

```bash
cd log4j-week1

# Build static demo
cd log4j-static-demo
mvn clean package

# Build dynamic demo
cd ../log4j-dynamic-demo
mvn clean package

# Verify runtime JARs exist
ls runtime-libs/*.jar
```

## Quick Start

Run the automated demo script:

```bash
cd log4j-week1
./demo-strace.sh
```

This will:

1. Build both projects
2. Run each with `strace` tracing file operations
3. Show the difference between static and dynamic loading

## Manual Demo

### Step 1: Static Loading Demo

```bash
cd log4j-week1/log4j-static-demo

# Get classpath
STATIC_CP="target/log4j-static-demo-1.0-SNAPSHOT.jar"
STATIC_DEPS=$(mvn -q dependency:build-classpath -Dmdep.outputFile=/dev/stdout)
FULL_CP="$STATIC_CP:$STATIC_DEPS"

# Run with strace
strace -e trace=open,openat -f -s 200 \
    java -cp "$FULL_CP" com.example.App 2>&1 | \
    grep -E "(log4j|\.jar)" | head -20
```

**Expected output:**

- JARs from Maven repository (`~/.m2/repository/`)
- Shows compile-time dependencies being loaded

### Step 2: Dynamic Loading Demo

```bash
cd log4j-week1/log4j-dynamic-demo

# Run with strace
strace -e trace=open,openat -f -s 200 \
    java -cp target/log4j-dynamic-demo-1.0-SNAPSHOT.jar com.example.App 2>&1 | \
    grep -E "(runtime-libs|log4j|\.jar)" | head -20
```

**Expected output:**

```
openat(AT_FDCWD, "runtime-libs/log4j-api-2.25.2.jar", ...)
openat(AT_FDCWD, "runtime-libs/log4j-core-2.25.2.jar", ...)
```

**Key observation:** JARs are opened from `runtime-libs/` directory, proving dynamic loading!

## Understanding `strace` Output

### System Call Format

```
openat(AT_FDCWD, "path/to/file.jar", O_RDONLY|O_CLOEXEC) = 15
```

- **`openat`** - System call to open a file
- **`AT_FDCWD`** - Current working directory
- **File path** - Shows where JAR is loaded from
- **Return value** - File descriptor number

### Key System Calls to Look For

1. **`openat`** / **`open`** - File open operations

   - Shows JAR files being loaded
   - Reveals source location

2. **`read`** - File reading operations

   - May show class file reads from JARs

3. **`stat`** - File status checks
   - May show JAR existence checks

## Filtering `strace` Output

### Show only file opens

```bash
strace -e trace=open,openat -f java -cp ... com.example.App
```

### Show only JAR-related operations

```bash
strace -e trace=open,openat -f -s 200 java -cp ... com.example.App 2>&1 | \
    grep -E "\.jar"
```

### Save to file for analysis

```bash
strace -e trace=open,openat -f -s 200 -o trace.log \
    java -cp ... com.example.App
```

### Show timing information

```bash
strace -e trace=open,openat -f -s 200 -tt \
    java -cp ... com.example.App
```

## Comparing with SBOMs

### Static SBOM (`bom.json`)

- Generated from `pom.xml` dependencies
- Shows Log4j as a compile-time dependency
- **Matches:** `strace` shows JARs from Maven cache

### Dynamic SBOM (`sbom-dynamic.json`)

- Generated by scanning `runtime-libs/` directory
- Shows Log4j discovered at runtime
- **Matches:** `strace` shows JARs opened from `runtime-libs/`

## Troubleshooting

### Issue: `strace: command not found`

**Solution:** Install `strace` (see Prerequisites)

### Issue: Permission denied

**Solution:** On some systems, `strace` may require `sudo`:

```bash
sudo strace -e trace=open,openat -f java -cp ... com.example.App
```

### Issue: Too much output

**Solution:** Filter to specific system calls:

```bash
strace -e trace=open,openat -f java -cp ... com.example.App
```

### Issue: macOS compatibility

**Solution:** Use `dtruss` (wrapper for `dtrace`):

```bash
sudo dtruss -n java java -cp ... com.example.App
```

### Issue: No JAR files in trace

**Possible causes:**

- JARs already in classpath (static loading)
- JARs loaded via different mechanism
- Filter too restrictive

**Solution:** Try broader trace:

```bash
strace -e trace=file -f -s 200 java -cp ... com.example.App
```

## Advanced Usage

### Trace specific threads

```bash
strace -f -p <PID> -e trace=open,openat
```

### Show system call statistics

```bash
strace -c -e trace=open,openat -f java -cp ... com.example.App
```

### Combine with other tools

```bash
# Use strace with grep to find specific patterns
strace -e trace=open,openat -f -s 200 java -cp ... com.example.App 2>&1 | \
    grep -B2 -A2 "runtime-libs"
```

## Security Implications

1. **Complete dependency visibility:** `strace` shows what actually loads at runtime
2. **Hidden dependencies:** Can reveal libraries not in SBOMs
3. **Forensic analysis:** Useful for investigating unexpected behavior
4. **Compliance:** Provides runtime proof of what executes

## References

- `strace` man page: `man strace`
- [strace documentation](https://strace.io/)
- [Linux system calls](https://man7.org/linux/man-pages/man2/syscalls.2.html)
- [Java ClassLoader mechanism](https://docs.oracle.com/javase/tutorial/ext/basics/load.html)

## Next Steps

1. Run the demo script
2. Experiment with different `strace` filters
3. Compare output with SBOM contents
4. Try tracing other Java applications
5. Explore `strace` documentation for more options


